"use strict";var e;function t(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function n(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?t(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):t(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function r(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(exports,"__esModule",{value:!0});var a=require("react/jsx-runtime"),i=require("@sanity/icons"),o=require("sanity"),d=require("react"),s=require("react-big-calendar"),l=require("date-fns"),c=require("dlv"),u=require("@sanity/ui"),h=require("date-fns/format"),p=require("sanity/router"),f=require("date-fns/locale/en-US"),m=require("styled-components");function x(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}require("react-big-calendar/lib/css/react-big-calendar.css");var g=x(c),b=x(h),y=x(f),v=x(m);function j(e){return o.useClient({apiVersion:null!=e?e:"2021-09-06"})}const w={calendar:{events:{dateFormat:"MMMM dd, yyyy",timeFormat:"HH:mm"},nativeOptions:{views:["month","agenda"]},showAuthor:!0},types:[],filterWarnings:[]},O=d.createContext(w),S="Untitled?",C=()=>{const[e,t]=d.useState([]),n=d.useContext(O).types,r=n.map((e=>e.type)),a=e=>{if(e){const t=n.find((t=>t.type===e._type));if(t)return g.default(e,t.titleField,S)}return S},i=()=>{s.fetch('* [_type == "schedule.metadata" && !(_id in path(\'drafts.**\'))] {\n      ...,\n      "doc": * [_id == "drafts." + ^.documentId ][0]\n    }\n  ',{types:r}).then(o)},o=e=>{const n=e.filter((e=>!!e.doc&&!!e.datetime)).map((e=>({start:l.parseISO(e.datetime),end:l.parseISO(e.datetime),doc:e.doc,title:a(e.doc),user:e.user,scheduledAt:e.scheduledAt})));t(n)},s=j("v1");return d.useEffect((()=>{i();const e=s.observable.listen("* [_type == \"schedule.metadata\" && !(_id in path('drafts.**'))]",{types:r}).subscribe((e=>{setTimeout((()=>{i()}),2500)}));return()=>{e.unsubscribe()}}),[s]),e},T=e=>{var t;const n=(null==(t=e.doc)?void 0:t._id)||"",{filterWarnings:r}=d.useContext(O),[a,i]=d.useState(!1),o=j("v1");return d.useEffect((()=>{let t;return n&&(t=o.observable.fetch('*[_id in path("drafts.'.concat(n,'") || _id == "').concat(n,'"] | order(_updatedAt desc)')).subscribe((t=>{(t=>{if((null==r?void 0:r.length)&&r.filter((e=>{var t;return null==(t=Object.keys(e))?void 0:t.length})).map((e=>Object.keys(e).filter((n=>g.default(t,n)===g.default(e,n))).length===Object.keys(e).length)).some((e=>e)))return i(!1);l.isAfter(l.parseISO(t._updatedAt),l.parseISO(e.scheduledAt))&&i(!0)})(t[0])}))),()=>{t&&t.unsubscribe()}}),[n,o]),a};function I(){return a.jsx(u.Card,{tone:"caution",shadow:1,padding:3,radius:2,children:a.jsxs(u.Flex,{gap:3,children:[a.jsx(u.Text,{size:2,children:a.jsx(i.WarningOutlineIcon,{})}),a.jsxs(u.Stack,{space:3,flex:1,children:[a.jsx(u.Box,{children:a.jsx(u.Text,{weight:"semibold",children:"Warning"})}),a.jsx(u.Box,{children:a.jsx(u.Text,{size:1,children:"The document has changed since it was scheduled for publishing. Please review it and reschedule if needed."})})]})]})})}function F(e){let{user:t,minimal:n=!1}=e;return a.jsx(u.Flex,{children:n?a.jsx(o.UserAvatar,{user:t}):a.jsx(u.Box,{children:a.jsxs(u.Inline,{space:1,children:[a.jsx(o.UserAvatar,{user:t}),a.jsx(u.Text,{children:t.displayName})]})})})}function _(e){let{event:t,onClose:n}=e;const r=T(t),s=p.useRouter(),c=o.useSchema(),h=w.calendar.events,{calendar:{events:{timeFormat:f=h.timeFormat,dateFormat:m=h.dateFormat},showAuthor:x}}=d.useContext(O);if(!t.doc)return null;const g=c.get(t.doc._type),b=o.getPublishedId(t.doc._id);return a.jsxs(u.Stack,{padding:4,space:4,children:[r&&a.jsx(I,{}),g&&a.jsx(o.Preview,{layout:"default",value:t.doc,schemaType:g}),a.jsxs(u.Grid,{gap:2,columns:x?2:1,children:[a.jsxs(u.Stack,{space:2,children:[a.jsx(u.Label,{muted:!0,size:1,children:"Scheduled For"}),a.jsx(u.Box,{paddingY:1,children:a.jsxs(u.Text,{children:[l.format(t.start,m)," â€¢ ",l.format(t.start,f)]})})]}),x&&a.jsxs(u.Stack,{space:2,children:[a.jsx(u.Label,{muted:!0,size:1,children:"Scheduled By"}),a.jsx(F,{user:t.user})]})]}),a.jsxs(u.Flex,{gap:3,justify:"space-between",children:[a.jsx(u.Button,{tone:r?"caution":"positive",icon:r?i.RevertIcon:i.EditIcon,text:r?"Review":"Edit",onClick:()=>{return t.doc&&(e=b,n=t.doc._type,s.navigateIntent("edit",{id:e,type:n}));var e,n}}),a.jsx(u.Button,{mode:"ghost",onClick:n,text:"Close"})]})]})}function P(e){let{event:t,isOpen:n,onClose:r}=e;const{calendar:{events:{dateFormat:i=w.calendar.events.dateFormat,dialogTitle:o}}}=d.useContext(O),s="date"===o?b.default(t.start,i):"Schedule details",l=d.useRef("".concat(Math.random()));return n?a.jsx(u.Dialog,{id:l.current,header:o||s,onClose:r,width:1,children:a.jsx(_,{event:t,onClose:r})}):null}const k=[{name:"previous",increment:-1,action:"PREV"},{name:"today",increment:0,action:"TODAY"},{name:"next",increment:1,action:"NEXT"}],A=v.default(u.Box)(e||(E=["\n  position: absolute;\n  width: calc(100% - 2.5em);\n  height: calc(100% - 2.5em - 51px);\n  color: ",";\n  font-family: ",";\n\n  & th.rbc-header {\n    text-align: right;\n    font-family: ",";\n    font-weight: ",";\n    padding: 1em;\n  }\n\n  & .rbc-day-bg.rbc-off-range-bg {\n    background: ",";\n  }\n\n  & div.rbc-now button {\n    background: ",";\n    border-radius: 50%;\n    font-weight: bold;\n    color: white;\n    display: flex;\n    width: 25px;\n    height: 25px;\n    align-items: center;\n    justify-content: center;\n    line-height: 1;\n    margin-left: auto;\n  }\n\n  & .rbc-event {\n    background: none;\n  }\n\n  & .rbc-date-cell {\n    margin-top: 0.25em;\n  }\n\n  & .rbc-day-bg,\n  .rbc-header,\n  .rbc-month-row,\n  .rbc-month-view,\n  .rbc-agenda-view table.rbc-agenda-table,\n  .rbc-agenda-view table.rbc-agenda-table thead > tr > th,\n  .rbc-agenda-view table.rbc-agenda-table tbody > tr > td + td {\n    border-color: ",";\n  }\n\n  & .rbc-day-bg.rbc-today {\n    background: none;\n  }\n"],B||(B=E.slice(0)),e=Object.freeze(Object.defineProperties(E,{raw:{value:Object.freeze(B)}}))),(e=>{let{studioTheme:t}=e;return t.color.card.enabled.fg}),(e=>{let{studioTheme:t}=e;return t.fonts.text.family}),(e=>{let{studioTheme:t}=e;return t.fonts.heading.family}),(e=>{let{studioTheme:t}=e;return t.fonts.heading.weights.regular}),(e=>{let{studioTheme:t}=e;return t.color.input.default.disabled.bg}),(e=>{let{studioTheme:t}=e;return t.color.button.default.primary.enabled.bg}),(e=>{let{studioTheme:t}=e;return t.color.card.enabled.border}));var E,B;const z={"en-US":y.default},D=s.dateFnsLocalizer({format:l.format,parse:l.parse,startOfWeek:l.startOfWeek,getDay:l.getDay,locales:z}),q={event:function(e){let{event:t}=e;const n=T(t),{calendar:{events:{timeFormat:r=w.calendar.events.timeFormat}}}=d.useContext(O);return a.jsx(u.Box,{padding:1,children:a.jsx(u.Card,{tone:n?"caution":"primary",padding:2,paddingTop:1,shadow:1,radius:2,children:a.jsxs(u.Flex,{align:"center",gap:2,children:[n&&a.jsx(i.WarningOutlineIcon,{}),a.jsxs(u.Stack,{space:2,children:[a.jsx(u.Text,{size:1,weight:"semibold",style:{paddingTop:5,textOverflow:"ellipsis",overflowX:"clip"},children:t.title}),a.jsx(u.Text,{size:0,children:l.format(t.start,r)})]})]})})})},toolbar:function(e){const{label:t,views:n,view:r,onView:o,onNavigate:d,localizer:s,date:l}=e;return a.jsx(u.Box,{paddingBottom:3,children:a.jsxs(u.Flex,{align:"center",children:[a.jsx(u.Box,{flex:1,children:a.jsx(u.Text,{size:4,weight:"bold",children:t})}),a.jsx(u.Box,{children:a.jsxs(u.Flex,{gap:2,align:"center",children:[a.jsx(u.Card,{radius:4,overflow:"auto",padding:1,shadow:1,tone:"primary",children:a.jsx(u.Flex,{gap:1,align:"center",children:n.map((e=>a.jsx(u.Button,{fontSize:1,padding:3,radius:3,tone:"primary",icon:"month"===e?i.CalendarIcon:i.ThListIcon,mode:r===e?"default":"bleed",text:s.messages[e],onClick:()=>o(e)},e)))})}),a.jsx(u.Card,{radius:4,overflow:"auto",padding:1,shadow:1,tone:"primary",children:a.jsx(u.Flex,{gap:1,align:"center",children:k.map((e=>{let{name:t,increment:n,action:r}=e;return a.jsx(u.Button,{fontSize:1,icon:"previous"===t?i.ChevronLeftIcon:void 0,iconRight:"next"===t?i.ChevronRightIcon:void 0,padding:3,radius:3,tone:"primary",mode:"bleed",text:s.messages[t],onClick:()=>function(){let e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"NEXT",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;e=0===n?new Date:new Date(l.getFullYear(),l.getMonth()+n,l.getDate()),d(t,e)}(r,n)},t)}))})})]})})]})})},agenda:{event:function(e){let{event:t}=e;const n=T(t),r=p.useRouter(),s=o.useSchema(),{calendar:{showAuthor:l}}=d.useContext(O);if(!t.doc)return null;const c=o.getPublishedId(t.doc._id),h=s.get(t.doc._type);return a.jsxs(u.Stack,{padding:2,space:2,children:[n&&a.jsx(I,{}),a.jsxs(u.Flex,{align:"center",gap:4,children:[a.jsx(u.Box,{flex:1,children:h&&a.jsx(o.Preview,{layout:"default",value:t.doc,schemaType:h})}),l&&a.jsxs(u.Inline,{space:2,children:[a.jsx(u.Label,{muted:!0,size:1,children:"Scheduled By"}),a.jsx(F,{user:t.user})]}),a.jsx(u.Flex,{gap:3,justify:"space-between",children:a.jsx(u.Button,{tone:n?"caution":"positive",icon:n?i.RevertIcon:i.EditIcon,text:n?"Review":"Edit",onClick:()=>{return t.doc&&(e=c,n=t.doc._type,r.navigateIntent("edit",{id:e,type:n}));var e,n}})})]})]})}},header:e=>{let{label:t}=e;return a.jsx(u.Flex,{padding:2,justify:"flex-end",flex:1,children:a.jsx(u.Text,{size:1,children:t})})}};function R(){const e=C(),[t,r]=d.useState(!1),[i,o]=d.useState(null),[l,c]=function(e,t){const[n,r]=d.useState((()=>{const n=window.localStorage.getItem(t);return null===n?e:JSON.parse(n)}));return d.useEffect((()=>{window.localStorage.setItem(t,JSON.stringify(n))}),[t,n]),[n,r]}("month","sanity-calendar-view"),{calendar:{nativeOptions:h}}=d.useContext(O),p=u.useTheme().sanity;return a.jsx(A,{padding:4,studioTheme:p,children:a.jsxs(u.Flex,{direction:"column",height:"fill",flex:1,children:[a.jsx(s.Calendar,n({components:q,className:"calendar",defaultView:l,onView:e=>c(e),localizer:D,events:e,startAccessor:"start",endAccessor:"end",onSelectEvent:e=>{r(!0),o(e)}},h)),t&&i&&a.jsx(P,{event:i,isOpen:t,onClose:()=>{r(!1),o(null)}})]})})}function N(e,t){return t.find((t=>t.type===e))}function U(e){let{draft:t,types:n}=e;if(!t)return null;const r=n.find((e=>e.type===t._type));return r?g.default(t,r.field):null}function H(e){let{id:t}=e;const n=M(t);return n&&n.data&&!!n.data.datetime&&!!n.data.rev}function M(e){const t="schedule-metadata.".concat(e),n="schedule.metadata",r=o.useEditState(t,n),a=o.useDocumentOperation(t,n),i=r&&r.published?r.published:{_id:t,_type:n},d=j(),s=o.useCurrentUser();return{commit:function(){a.commit.execute()},data:i,delete:function(){a.delete.execute()},setData:function(r,a){d.createOrReplace({_id:t,_type:n,documentId:e,datetime:r,rev:a,user:s?{id:s.id,displayName:s.name,imageUrl:s.profileImage,email:s.email}:void 0,scheduledAt:(new Date).toISOString()})}}}function W(e){let{id:t,draft:n}=e;const r=M(t);return n&&r.data&&r.data.datetime?{label:"Scheduled",title:"Scheduled to publish at ".concat(r.data.datetime),color:"warning"}:null}function L(e){return t=>V(n(n({},t),{},{types:e}))}const V=e=>{let{id:t,onComplete:n}=e;const r=H({id:t}),a=M(t);return r?{disabled:!r,icon:i.CalendarIcon,color:"danger",label:"Unschedule",onHandle:()=>{a.delete(),n()}}:null};function X(e){return t=>Y(n(n({},t),{},{types:e}))}const Y=e=>{let{id:t,draft:n,onComplete:r,type:a,liveEdit:d,types:s}=e;const c=M(t),u=o.useValidationStatus(t,a),h=H({id:t});if(d||!N(a,s))return null;if(!n)return null;const p=U({draft:n,types:s});if(!p)return null;if(!l.isFuture(l.parseISO(p)))return null;const f=u.validation.some((e=>"error"===e.level)),m=function(e){let{draft:t,types:n}=e;const r=U({draft:t,types:n});if(r){const e=l.parseISO(r);return l.isFuture(e)}return!1}({draft:n,types:s})&&!f,x=p!==c.data.datetime,g=n._rev!==c.data.rev;return x||g?{disabled:!m,icon:i.CalendarIcon,label:h?"Reschedule":"Schedule",color:h?"warning":"success",onHandle:()=>{c.setData(p,n._rev),r()}}:null},J=e=>function(t){const r=e.find((e=>"delete"===e.action));if(!r)throw new Error('actions did not contain any actions with action === "delete"');const a=M(t.id);return r(n(n({},t),{},{onComplete:()=>{a.delete(),t.onComplete()}}))},G=e=>function(t){const r=e.find((e=>"publish"===e.action));if(!r)throw new Error('actions did not contain any actions with action === "publish"');const a=M(t.id),i=r(t);if(!i)throw new Error('action with action === "publish" returned null');return n(n({},i),{},{onHandle:()=>{(null==i?void 0:i.onHandle)&&i.onHandle(),a.delete()}})};function K(e){let{type:t,types:n}=e,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(N(t,n)){return[...[X(n),L(n),G(r),J(r)],...r.filter((e=>"delete"!==e.action&&"publish"!==e.action))]}return r}function Q(e){return[...e,W]}const Z=o.definePlugin((e=>{const t=n(n({},w),e);return{name:"content-calendar",document:{actions:(e,n)=>{let{schemaType:r}=n;return K({type:r,types:t.types},e)},badges:(e,t)=>{let{schemaType:n}=t;return Q(e)}},tools:e=>[...e,{name:"calendar",title:"Calendar",icon:i.CalendarIcon,component:function(){return a.jsx(O.Provider,{value:t,children:a.jsx(R,{})})}}]}}));exports.addActions=K,exports.addBadge=Q,exports.contentCalendar=Z,exports.createCalendarDeleteAction=J,exports.createCalendarPublishAction=G,exports.createScheduleAction=X,exports.createUnScheduleAction=L,exports.schedulingEnabled=N;//# sourceMappingURL=index.js.map
