var e;function t(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function n(e){for(var n=1;n<arguments.length;n++){var i=null!=arguments[n]?arguments[n]:{};n%2?t(Object(i),!0).forEach((function(t){r(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):t(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function r(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}import{jsx as i,jsxs as a}from"react/jsx-runtime";import{WarningOutlineIcon as o,RevertIcon as d,EditIcon as c,CalendarIcon as l,ThListIcon as s,ChevronLeftIcon as u,ChevronRightIcon as p}from"@sanity/icons";import{useClient as h,UserAvatar as m,useSchema as f,getPublishedId as g,Preview as b,useEditState as y,useDocumentOperation as v,useCurrentUser as w,useValidationStatus as O,definePlugin as j}from"sanity";import{createContext as x,useState as _,useContext as S,useEffect as T,useRef as C}from"react";import{dateFnsLocalizer as z,Calendar as P}from"react-big-calendar";import{parseISO as k,isAfter as E,format as F,parse as A,startOfWeek as D,getDay as N,isFuture as I}from"date-fns";import H from"dlv";import{Card as M,Flex as R,Text as U,Stack as V,Box as W,Inline as B,Grid as X,Label as Y,Button as J,Dialog as q,useTheme as G}from"@sanity/ui";import K from"date-fns/format";import{useRouter as L}from"sanity/router";import Q from"date-fns/locale/en-US";import Z from"styled-components";import"react-big-calendar/lib/css/react-big-calendar.css";function $(e){return h({apiVersion:null!=e?e:"2021-09-06"})}const ee={calendar:{events:{dateFormat:"MMMM dd, yyyy",timeFormat:"HH:mm"},nativeOptions:{views:["month","agenda"]},showAuthor:!0},types:[],filterWarnings:[]},te=x(ee),ne="Untitled?",re=()=>{const[e,t]=_([]),n=S(te).types,r=n.map((e=>e.type)),i=e=>{if(e){const t=n.find((t=>t.type===e._type));if(t)return H(e,t.titleField,ne)}return ne},a=()=>{d.fetch('* [_type == "schedule.metadata" && !(_id in path(\'drafts.**\'))] {\n      ...,\n      "doc": * [_id == "drafts." + ^.documentId ][0]\n    }\n  ',{types:r}).then(o)},o=e=>{const n=e.filter((e=>!!e.doc&&!!e.datetime)).map((e=>({start:k(e.datetime),end:k(e.datetime),doc:e.doc,title:i(e.doc),user:e.user,scheduledAt:e.scheduledAt})));t(n)},d=$("v1");return T((()=>{a();const e=d.observable.listen("* [_type == \"schedule.metadata\" && !(_id in path('drafts.**'))]",{types:r}).subscribe((e=>{setTimeout((()=>{a()}),2500)}));return()=>{e.unsubscribe()}}),[d]),e},ie=e=>{var t;const n=(null==(t=e.doc)?void 0:t._id)||"",{filterWarnings:r}=S(te),[i,a]=_(!1),o=$("v1");return T((()=>{let t;return n&&(t=o.observable.fetch('*[_id in path("drafts.'.concat(n,'") || _id == "').concat(n,'"] | order(_updatedAt desc)')).subscribe((t=>{(t=>{if((null==r?void 0:r.length)&&r.filter((e=>{var t;return null==(t=Object.keys(e))?void 0:t.length})).map((e=>Object.keys(e).filter((n=>H(t,n)===H(e,n))).length===Object.keys(e).length)).some((e=>e)))return a(!1);E(k(t._updatedAt),k(e.scheduledAt))&&a(!0)})(t[0])}))),()=>{t&&t.unsubscribe()}}),[n,o]),i};function ae(){return i(M,{tone:"caution",shadow:1,padding:3,radius:2,children:a(R,{gap:3,children:[i(U,{size:2,children:i(o,{})}),a(V,{space:3,flex:1,children:[i(W,{children:i(U,{weight:"semibold",children:"Warning"})}),i(W,{children:i(U,{size:1,children:"The document has changed since it was scheduled for publishing. Please review it and reschedule if needed."})})]})]})})}function oe(e){let{user:t,minimal:n=!1}=e;return i(R,{children:n?i(m,{user:t}):i(W,{children:a(B,{space:1,children:[i(m,{user:t}),i(U,{children:t.displayName})]})})})}function de(e){let{event:t,onClose:n}=e;const r=ie(t),o=L(),l=f(),s=ee.calendar.events,{calendar:{events:{timeFormat:u=s.timeFormat,dateFormat:p=s.dateFormat},showAuthor:h}}=S(te);if(!t.doc)return null;const m=l.get(t.doc._type),y=g(t.doc._id);return a(V,{padding:4,space:4,children:[r&&i(ae,{}),m&&i(b,{layout:"default",value:t.doc,schemaType:m}),a(X,{gap:2,columns:h?2:1,children:[a(V,{space:2,children:[i(Y,{muted:!0,size:1,children:"Scheduled For"}),i(W,{paddingY:1,children:a(U,{children:[F(t.start,p)," â€¢ ",F(t.start,u)]})})]}),h&&a(V,{space:2,children:[i(Y,{muted:!0,size:1,children:"Scheduled By"}),i(oe,{user:t.user})]})]}),a(R,{gap:3,justify:"space-between",children:[i(J,{tone:r?"caution":"positive",icon:r?d:c,text:r?"Review":"Edit",onClick:()=>{return t.doc&&(e=y,n=t.doc._type,o.navigateIntent("edit",{id:e,type:n}));var e,n}}),i(J,{mode:"ghost",onClick:n,text:"Close"})]})]})}function ce(e){let{event:t,isOpen:n,onClose:r}=e;const{calendar:{events:{dateFormat:a=ee.calendar.events.dateFormat,dialogTitle:o}}}=S(te),d="date"===o?K(t.start,a):"Schedule details",c=C("".concat(Math.random()));return n?i(q,{id:c.current,header:o||d,onClose:r,width:1,children:i(de,{event:t,onClose:r})}):null}const le=[{name:"previous",increment:-1,action:"PREV"},{name:"today",increment:0,action:"TODAY"},{name:"next",increment:1,action:"NEXT"}],se=Z(W)(e||(ue=["\n  position: absolute;\n  width: calc(100% - 2.5em);\n  height: calc(100% - 2.5em - 51px);\n  color: ",";\n  font-family: ",";\n\n  & th.rbc-header {\n    text-align: right;\n    font-family: ",";\n    font-weight: ",";\n    padding: 1em;\n  }\n\n  & .rbc-day-bg.rbc-off-range-bg {\n    background: ",";\n  }\n\n  & div.rbc-now button {\n    background: ",";\n    border-radius: 50%;\n    font-weight: bold;\n    color: white;\n    display: flex;\n    width: 25px;\n    height: 25px;\n    align-items: center;\n    justify-content: center;\n    line-height: 1;\n    margin-left: auto;\n  }\n\n  & .rbc-event {\n    background: none;\n  }\n\n  & .rbc-date-cell {\n    margin-top: 0.25em;\n  }\n\n  & .rbc-day-bg,\n  .rbc-header,\n  .rbc-month-row,\n  .rbc-month-view,\n  .rbc-agenda-view table.rbc-agenda-table,\n  .rbc-agenda-view table.rbc-agenda-table thead > tr > th,\n  .rbc-agenda-view table.rbc-agenda-table tbody > tr > td + td {\n    border-color: ",";\n  }\n\n  & .rbc-day-bg.rbc-today {\n    background: none;\n  }\n"],pe||(pe=ue.slice(0)),e=Object.freeze(Object.defineProperties(ue,{raw:{value:Object.freeze(pe)}}))),(e=>{let{studioTheme:t}=e;return t.color.card.enabled.fg}),(e=>{let{studioTheme:t}=e;return t.fonts.text.family}),(e=>{let{studioTheme:t}=e;return t.fonts.heading.family}),(e=>{let{studioTheme:t}=e;return t.fonts.heading.weights.regular}),(e=>{let{studioTheme:t}=e;return t.color.input.default.disabled.bg}),(e=>{let{studioTheme:t}=e;return t.color.button.default.primary.enabled.bg}),(e=>{let{studioTheme:t}=e;return t.color.card.enabled.border}));var ue,pe;const he=z({format:F,parse:A,startOfWeek:D,getDay:N,locales:{"en-US":Q}}),me={event:function(e){let{event:t}=e;const n=ie(t),{calendar:{events:{timeFormat:r=ee.calendar.events.timeFormat}}}=S(te);return i(W,{padding:1,children:i(M,{tone:n?"caution":"primary",padding:2,paddingTop:1,shadow:1,radius:2,children:a(R,{align:"center",gap:2,children:[n&&i(o,{}),a(V,{space:2,children:[i(U,{size:1,weight:"semibold",style:{paddingTop:5,textOverflow:"ellipsis",overflowX:"clip"},children:t.title}),i(U,{size:0,children:F(t.start,r)})]})]})})})},toolbar:function(e){const{label:t,views:n,view:r,onView:o,onNavigate:d,localizer:c,date:h}=e;return i(W,{paddingBottom:3,children:a(R,{align:"center",children:[i(W,{flex:1,children:i(U,{size:4,weight:"bold",children:t})}),i(W,{children:a(R,{gap:2,align:"center",children:[i(M,{radius:4,overflow:"auto",padding:1,shadow:1,tone:"primary",children:i(R,{gap:1,align:"center",children:n.map((e=>i(J,{fontSize:1,padding:3,radius:3,tone:"primary",icon:"month"===e?l:s,mode:r===e?"default":"bleed",text:c.messages[e],onClick:()=>o(e)},e)))})}),i(M,{radius:4,overflow:"auto",padding:1,shadow:1,tone:"primary",children:i(R,{gap:1,align:"center",children:le.map((e=>{let{name:t,increment:n,action:r}=e;return i(J,{fontSize:1,icon:"previous"===t?u:void 0,iconRight:"next"===t?p:void 0,padding:3,radius:3,tone:"primary",mode:"bleed",text:c.messages[t],onClick:()=>function(){let e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"NEXT",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;e=0===n?new Date:new Date(h.getFullYear(),h.getMonth()+n,h.getDate()),d(t,e)}(r,n)},t)}))})})]})})]})})},agenda:{event:function(e){let{event:t}=e;const n=ie(t),r=L(),o=f(),{calendar:{showAuthor:l}}=S(te);if(!t.doc)return null;const s=g(t.doc._id),u=o.get(t.doc._type);return a(V,{padding:2,space:2,children:[n&&i(ae,{}),a(R,{align:"center",gap:4,children:[i(W,{flex:1,children:u&&i(b,{layout:"default",value:t.doc,schemaType:u})}),l&&a(B,{space:2,children:[i(Y,{muted:!0,size:1,children:"Scheduled By"}),i(oe,{user:t.user})]}),i(R,{gap:3,justify:"space-between",children:i(J,{tone:n?"caution":"positive",icon:n?d:c,text:n?"Review":"Edit",onClick:()=>{return t.doc&&(e=s,n=t.doc._type,r.navigateIntent("edit",{id:e,type:n}));var e,n}})})]})]})}},header:e=>{let{label:t}=e;return i(R,{padding:2,justify:"flex-end",flex:1,children:i(U,{size:1,children:t})})}};function fe(){const e=re(),[t,r]=_(!1),[o,d]=_(null),[c,l]=function(e,t){const[n,r]=_((()=>{const n=window.localStorage.getItem(t);return null===n?e:JSON.parse(n)}));return T((()=>{window.localStorage.setItem(t,JSON.stringify(n))}),[t,n]),[n,r]}("month","sanity-calendar-view"),{calendar:{nativeOptions:s}}=S(te),u=G().sanity;return i(se,{padding:4,studioTheme:u,children:a(R,{direction:"column",height:"fill",flex:1,children:[i(P,n({components:me,className:"calendar",defaultView:c,onView:e=>l(e),localizer:he,events:e,startAccessor:"start",endAccessor:"end",onSelectEvent:e=>{r(!0),d(e)}},s)),t&&o&&i(ce,{event:o,isOpen:t,onClose:()=>{r(!1),d(null)}})]})})}function ge(e,t){return t.find((t=>t.type===e))}function be(e){let{draft:t,types:n}=e;if(!t)return null;const r=n.find((e=>e.type===t._type));return r?H(t,r.field):null}function ye(e){let{id:t}=e;const n=ve(t);return n&&n.data&&!!n.data.datetime&&!!n.data.rev}function ve(e){const t="schedule-metadata.".concat(e),n="schedule.metadata",r=y(t,n),i=v(t,n),a=r&&r.published?r.published:{_id:t,_type:n},o=$(),d=w();return{commit:function(){i.commit.execute()},data:a,delete:function(){i.delete.execute()},setData:function(r,i){o.createOrReplace({_id:t,_type:n,documentId:e,datetime:r,rev:i,user:d?{id:d.id,displayName:d.name,imageUrl:d.profileImage,email:d.email}:void 0,scheduledAt:(new Date).toISOString()})}}}function we(e){let{id:t,draft:n}=e;const r=ve(t);return n&&r.data&&r.data.datetime?{label:"Scheduled",title:"Scheduled to publish at ".concat(r.data.datetime),color:"warning"}:null}function Oe(e){return t=>je(n(n({},t),{},{types:e}))}const je=e=>{let{id:t,onComplete:n}=e;const r=ye({id:t}),i=ve(t);return r?{disabled:!r,icon:l,color:"danger",label:"Unschedule",onHandle:()=>{i.delete(),n()}}:null};function xe(e){return t=>_e(n(n({},t),{},{types:e}))}const _e=e=>{let{id:t,draft:n,onComplete:r,type:i,liveEdit:a,types:o}=e;const d=ve(t),c=O(t,i),s=ye({id:t});if(a||!ge(i,o))return null;if(!n)return null;const u=be({draft:n,types:o});if(!u)return null;if(!I(k(u)))return null;const p=c.validation.some((e=>"error"===e.level)),h=function(e){let{draft:t,types:n}=e;const r=be({draft:t,types:n});if(r){const e=k(r);return I(e)}return!1}({draft:n,types:o})&&!p,m=u!==d.data.datetime,f=n._rev!==d.data.rev;return m||f?{disabled:!h,icon:l,label:s?"Reschedule":"Schedule",color:s?"warning":"success",onHandle:()=>{d.setData(u,n._rev),r()}}:null},Se=e=>function(t){const r=e.find((e=>"delete"===e.action));if(!r)throw new Error('actions did not contain any actions with action === "delete"');const i=ve(t.id);return r(n(n({},t),{},{onComplete:()=>{i.delete(),t.onComplete()}}))},Te=e=>function(t){const r=e.find((e=>"publish"===e.action));if(!r)throw new Error('actions did not contain any actions with action === "publish"');const i=ve(t.id),a=r(t);if(!a)throw new Error('action with action === "publish" returned null');return n(n({},a),{},{onHandle:()=>{(null==a?void 0:a.onHandle)&&a.onHandle(),i.delete()}})};function Ce(e){let{type:t,types:n}=e,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(ge(t,n)){return[...[xe(n),Oe(n),Te(r),Se(r)],...r.filter((e=>"delete"!==e.action&&"publish"!==e.action))]}return r}function ze(e){return[...e,we]}const Pe=j((e=>{const t=n(n({},ee),e);return{name:"content-calendar",document:{actions:(e,n)=>{let{schemaType:r}=n;return Ce({type:r,types:t.types},e)},badges:(e,t)=>{let{schemaType:n}=t;return ze(e)}},tools:e=>[...e,{name:"calendar",title:"Calendar",icon:l,component:function(){return i(te.Provider,{value:t,children:i(fe,{})})}}]}}));export{Ce as addActions,ze as addBadge,Pe as contentCalendar,Se as createCalendarDeleteAction,Te as createCalendarPublishAction,xe as createScheduleAction,Oe as createUnScheduleAction,ge as schedulingEnabled};//# sourceMappingURL=index.esm.js.map
